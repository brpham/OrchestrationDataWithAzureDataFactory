<!DOCTYPE html>
<!-- saved from url=(0047)https://labondemand.com/LabProfile/Manual/LABID -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Local Lab Instructions</title>


    <script src="./Media/css/jquery-2.1.4.min.js.download" type="text/javascript"></script>
    <script src="./Media/css/showdown.min.js.download"></script>
    <link rel="stylesheet" type="text/css" href="./Media/css/prettify.css">
    <script src="./Media/css/yaml.min.js.download"></script>
    <script src="./Media/css/LocalizeTo" type="text/javascript"></script>
    <link href="./Media/css/CloudClient.css" rel="stylesheet" type="text/css">
  
    <style type="text/css">
        body, html {
            font-family: Segoe UI,Tahoma,Verdana,Arial,sans-serif;
            font-size: 14px;
            padding: 0;
            margin: 0;
            background-color: #efefef;
            color: #000;
            height: 100%;
        }

        body {
            overflow:auto;
        }

        #outputWrapper {
            background-color: #efefef;
            min-height:100%;
        }

        .instructionsPreview {
            padding: 20px;
            height: 100%;
        }

        .instructionsPreview .page {
            position:relative;
            display: block !important;
            padding: 15px 20px;
            background-color:#fff;
            page-break-after: always;
            min-height:650px;
        }

        .instructionsPreview .page:not(:first-child) {
            margin-top:20px;
        }

        @media print {
            body, html{
                height:auto;
            }
            
            body {
                -webkit-print-color-adjust: exact;
            }

            div {
                page-break-inside: avoid;
            }

            #outputWrapper {
                background-color: transparent;
            }

            .instructionsPreview {
                padding: 0;
            }

            .instructionsPreview .page:not(:first-child) {
                margin-top: 0px;
            }

        }

        @page {
            margin-left: 1.5cm;
            margin-right: 1.5cm;
            margin-top: 1.5cm;
            margin-bottom: 1.5cm;
        }
    </style>
    <link id="themeStylesheet" href="./Media/css/Blue.css" rel="stylesheet">

</head>
<body>
    <div id="outputWrapper">
                <div id="instructions" class="instructionsPreview">
    </div>
    <input type="hidden" id="rawContent" value="<img src=&quot;Media\image0184.png&quot; style=&quot;width:6.5in;height:2.36597in&quot; />

# Control Flow with Azure Data Factory

**Introduction**

During this lab, you will learn how to configure Control Flow within your Azure Data Factory pipelines.

**Estimated Time**

90 minutes

**Objectives**

At the end of this lab, you will be able to:

-   Configure a Data Transformation pipeline.

-   Use the Flow Control to add error handling and control the path of execution.

**Logon Information**

Use the following credentials to login into virtual environment:

-   Username: **Administrator**

-   Password: **Microsoft1**

# Table of Contents

[Lab: Control Flow with Azure Data Factory 3](#lab-control-flow-with-azure-data-factory)

[Exercise 1: Prepare your environment 3](#section)

[Exercise 2: Implement Control Flow 5](#exercise-2-implement-control-flow)

[Exercise 3: Extend the Control Flow with Lookup and IF Condition activities 23](#exercise-3-extend-the-control-flow-with-lookup-and-if-condition-activities)

## Lab: Control Flow with Azure Data Factory

During this lab, you will learn how to do data transformations with Azure Data Factory.

### 

### Exercise 1: Prepare your environment

This step will take you through preparing your environment for the exercises which will follow.

#### Tasks

1.  Connect to the Microsoft Azure Portal

    Open Internet Explorer and navigate to [**http://portal.azure.com/**](http://portal.azure.com/) to connect to Microsoft Azure Portal. Sign in with your subscriptions credentials.

2.  Create database objects

<!-- -->

1.  Using either SSMS, Azure Data Studio or the Azure Portal connect to your **Azure SQL Database.** To get your SQL Server name, navigate to SQL Servers in the Azure Portal, click on your SQL Server, click on the **Properties** section under **Settings** and copy your Server name.

    <img src=&quot;Media\image0181.png&quot; style=&quot;width:4.45046in;height:3.37398in&quot; />

2.  Run the following scripts, in order, against the database to create the required database objects.

    \\LabFiles\\M03\_L02\_Lab1\\SalesLT\_ProductStaging.sql  
    \\LabFiles\\M03\_L02\_Lab1\\SalesLT\_usp\_CheckProductStaging.sql  
    \\LabFiles\\M03\_L02\_Lab1\\SalesLT\_usp\_GetRowCountProductStaging.sql  
    \\LabFiles\\M03\_L02\_Lab1\\SalesLT\_usp\_PrepareProductStaging.sql  
    \\LabFiles\\M03\_L02\_Lab1\\SalesLT\_usp\_TruncateProductStaging.sql

Exercise 1 has been completed.

### Exercise 2: Implement Control Flow

This exercise shows the benefits of using Control Flow within your pipeline.

#### Tasks

1.  Connect to Microsoft Azure Portal

    Open Internet Explorer and navigate to [**http://portal.azure.com/**](http://portal.azure.com/) to connect to Microsoft Azure Portal. Sign in with your subscriptions credentials.

2.  Prepare the Azure Blob Storage

<!-- -->

1.  Using Azure Storage Explorer or the Azure Portal connect to the storage account created by the ARM Template in M02\_L01\_Lab01.

2.  Create a blob container called **m03-l02-lab01** in the root of the storage account.

<!-- -->

3.  Upload the input file

<!-- -->

1.  A sample file to use as the input has been provided for you in the lab files **\\M03\_L02\_Lab01\\products.csv**.

2.  Using Azure Storage Explorer (or the Azure Portal) to upload this file to the **/m03-l02-lab01/csv** container and folder.  
    <img src=&quot;Media\image0190.png&quot; style=&quot;width:3.48566in;height:6.90035in&quot; alt=&quot;Graphical user interface, text, application Description automatically generated&quot; />

<!-- -->

4.  Log onto your Azure Data Factory

<!-- -->

1.  In the Azure portal, navigate to the ADF instance you previously provisioned and then launch the Azure Data Factory UI by selecting Open in the ADF blade

    <img src=&quot;Media\image0159.png&quot; style=&quot;width:3.03472in;height:1.45139in&quot; alt=&quot;Graphical user interface, text, application, chat or text message Description automatically generated&quot; />

<!-- -->

5.  Verify that you have configured the Linked Service to the Azure Blob Storage account created in a previous lab. If so, go to step 6; otherwise, continue with the instructions below:

<!-- -->

1.  If you do not have a Linked Service already in your Data Factory to your Blob Storage account, follow the steps below to create one:

    1.  Select the **Toolbox/Manage** button from the left panel.

    2.  Select **Linked Service** and then select **+New**.

        <img src=&quot;Media\image0168.png&quot; style=&quot;width:5.24905in;height:2.0727in&quot; alt=&quot;Graphical user interface, text, application Description automatically generated&quot; />

    3.  Select the **Azure Blob Storage** type and click the **Continue** button.  
        <img src=&quot;Media\image0163.png&quot; style=&quot;width:2.10357in;height:2.39888in&quot; />

    4.  Change the **Linked Service name** if desired (for example: use the storage account name).

    5.  Select your **Subscription** then your **Azure Storage Account** from the dropdown and click the **Create** button.

> <img src=&quot;Media\image0166.png&quot; style=&quot;width:4.50524in;height:6.60421in&quot; />

6.  Configure the Azure SQL Database Linked Service in ADF

<!-- -->

1.  From the Toolbox/Manage button from the left panel, under **Linked services**, select **+New**.

    <img src=&quot;Media\image0168.png&quot; style=&quot;width:5.89583in;height:2.3281in&quot; alt=&quot;Graphical user interface, text, application Description automatically generated&quot; />

2.  On the Data Store tab, select **Azure SQL Database** and click the **Continue** button.

<img src=&quot;Media\image0165.png&quot; style=&quot;width:3.16667in;height:4.76157in&quot; alt=&quot;Graphical user interface, application, Word Description automatically generated&quot; />

3.  Enter a name for the linked service. Something descriptive (for example: **AzureSQL\_&lt;DBName&gt;**)

4.  Select **AutoResolveIntegrationRuntime**.

5.  Select the **Subscription**, **Azure SQL Database server** and **database.**

6.  Select **SQL authentication** for **Authentication** **Type**.

7.  Enter the **User name** and **Password** use specified during lab module M01\_L02\_Lab01(Create and monitor Azure Data Factory using ARM).

8.  Select **Test Connection** and make sure the connection succeeds.

9.  Then select **Create**.

<!-- -->

7.  Create a Dataset – Azure Blob Storage

<!-- -->

1.  We will need a dataset that points to the file uploaded earlier in this exercise.

<!-- -->

10. Click on the **Author/Pencil** button in the left pane.

    <img src=&quot;Media\image0164.png&quot; style=&quot;width:1.4135in;height:2.69648in&quot; />

11. Create a new dataset by clicking the **+** button and selecting **Dataset**

    <img src=&quot;Media\image0183.png&quot; style=&quot;width:2in;height:0.44964in&quot; />

12. Select **Azure Blob Storage** and then **Continue**.

13. Select **DelimitedText** and then **Continue**.

14. Provide a name for the dataset, such as **ProductsCSV,** and select the **Linked Service** created for Blob Storage in an earlier exercise.

15. **Browse** to the csv file uploaded (m03-l02-lab01/csv/Products.csv) and check the box for **First row as header**.

16. Click the **OK** button.

<img src=&quot;Media\image0182.png&quot; style=&quot;width:5.30208in;height:2.85629in&quot; />

8.  Create a Dataset – Azure SQL Database

<!-- -->

1.  We will need a dataset that points to the Azure SQL Database so that we can use it within our activities.

2.  Create a new dataset by clicking the **+** button and selecting **Dataset**.

3.  Select the **Azure SQL Database** and then **Continue**.

4.  On the Set Properties tab, change the dataset Name to **ProductStaging**.

5.  Select the **Linked Service** you created earlier in this exercise, and the table **\[SalesLT\].\[ProductStaging\]**.

> <img src=&quot;Media\image0185.png&quot; style=&quot;width:4.34155in;height:2.20273in&quot; />

17. Select **OK** to save the dataset.

<!-- -->

9.  Create a Pipeline and data gestation

<!-- -->

1.  Create a new pipeline by clicking the **+** button and selecting **Pipeline**.

2.  Under **Activities**, expand the **Move** **&** **transform** and drag the **Copy Data** activity to the designer surface.

> <img src=&quot;Media\image0188.png&quot; style=&quot;width:4.47241in;height:1.28295in&quot; />

18. In the Copy Data General tab, set the Name to **Import CSV**.

19. Switch to the **Source** tab. Select the **ProductsCSV** dataset.

    <img src=&quot;Media\image0187.png&quot; style=&quot;width:4.15197in;height:0.84184in&quot; />

20. Switch to the **Sink** tab. Select the **ProductsStaging** Linked Service for the destination we will copy to. Set the Storage Procedure Name to **None**.

<img src=&quot;Media\image0186.png&quot; style=&quot;width:4.81771in;height:1.18352in&quot; />

21. Switch to the **Mapping** tab. Choose **Import Schemas.** Remove the **row for the StagingID column** by clicking the check box to the left and click **Delete**.

> <img src=&quot;Media\image0177.png&quot; style=&quot;width:4.45511in;height:1.57642in&quot; />

22. If you have Git configured, click the **Save all** button to save your changes.

23. Click the **Publish** button to save the changes to the Pipeline before proceeding.

<!-- -->

10. Add Data validation activity

<!-- -->

1.  From the list of **General** **Activities**, add a **Stored Procedure** activity to the designer surface of the Pipeline you are working on.

<img src=&quot;Media\image0176.png&quot; style=&quot;width:4in;height:3.20299in&quot; />

24. Change the name of the activity to **Validate Import Rows**.

25. Switch to the **Settings** tab and select your SQL Linked Service **\[SalesLT\].\[usp\_CheckProductStaging\]** from the drop-down list.

    <img src=&quot;Media\image0175.png&quot; style=&quot;width:4.01214in;height:1.14363in&quot; />

26. Select **Save a**ll (if Git configured) then **Publish** on the Pipeline to deploy changes.

<!-- -->

11. Add Logic Apps for sending email notifications

<!-- -->

1.  In the Azure Portal, enter **Logic** **app** in the search bar, then click Add or **Create**

    <img src=&quot;Media\image0178.png&quot; style=&quot;width:2.75709in;height:2.36123in&quot; alt=&quot;Graphical user interface Description automatically generated with medium confidence&quot; />

<!-- -->

27. Select the **Resource** **Group** you have been using for the workshop.

28. Change type to Consumption

29. Give the Logical app a suitable **name** (i.e. &lt;initials&gt;-la-pipeline-status).

30. Choose East US Region

31. Check no for Enable log analytics

    <img src=&quot;Media\image0180.png&quot; style=&quot;width:4.27477in;height:3.78472in&quot; alt=&quot;Graphical user interface, text, application, email Description automatically generated&quot; />

32. Click **Review and Create**, then **Create**.

33. After it has deployed, click on **Go to resource**.

34. In the Logic App Designer, select the Http Trigger (**When** **a HTTP request is received**).

35. Add the text from the **\\LabFiles\\M03-L02-Lab01\\HTTPRequestBodyJSON.txt** file to the **Request Body JSON Schema** section

    {

    &quot;properties&quot;: {

    &quot;DataFactoryName&quot;: {

    &quot;type&quot;: &quot;string&quot;

    },

    &quot;PipelineName&quot;: {

    &quot;type&quot;: &quot;string&quot;

    },

    &quot;ErrorMessage&quot;: {

    &quot;type&quot;: &quot;string&quot;

    },

    &quot;PipelineStatus&quot;: {

    &quot;type&quot;: &quot;string&quot;

    },

    &quot;EmailTo&quot;: {

    &quot;type&quot;: &quot;string&quot;

    }

    },

    &quot;type&quot;: &quot;object&quot;

    }

    } <img src=&quot;Media\image0179.png&quot; style=&quot;width:4.04167in;height:2.46257in&quot; />

36. Select the **+New Step** use the search bar to find and select **Outlook.com – Send an email**. (Note this is the provider for your email account. You can use other mail provider activities such as Office 365.com, Gmail, etc. but these may have slight variations in sign-in/authentication processes and configuration) Also, your browser cannot be in Incognito and/or InPrivate mode when signing in.

37. **Best option : Sign In** and use your corporate email. **Additional Option**: You may be able to use a personal email, such as the email you registered for the class with or a gmail account.

<img src=&quot;Media\image0198.png&quot; style=&quot;width:5.27083in;height:1.83333in&quot; alt=&quot;Graphical user interface, application Description automatically generated&quot; />

38. Enter the details of the email. You can either hard code the fields, or to make this more scalable use a combination of text and the dynamic fields selector as shown below. When you click into a field, a fly out box will appear with the available Dynamic content and Expression builder.  
    <img src=&quot;Media\image0197.png&quot; style=&quot;width:5.79483in;height:3.69792in&quot; alt=&quot;Graphical user interface, text, application Description automatically generated&quot; />

    Hint: if you do not see the json parameters when your cursor is in any of the Email required fields, click on the **See more** hyperlink in the Dynamic content section.

    <img src=&quot;Media\image0196.png&quot; style=&quot;width:3.47917in;height:1.33382in&quot; alt=&quot;Graphical user interface, application Description automatically generated&quot; />

39. **Save** when ready.  
    <img src=&quot;Media\image0199.png&quot; style=&quot;width:4.90625in;height:0.36797in&quot; />

40. Expand the **HTTP request** trigger and copy the **HTTP Post URL** for later reference (into Notepad or similar).  
    <img src=&quot;Media\image0202.png&quot; style=&quot;width:4.8125in;height:0.89257in&quot; />

    <img src=&quot;Media\image0201.png&quot; style=&quot;width:4.85455in;height:1.85417in&quot; />

<!-- -->

12. Configure the Pipeline Parameters

<!-- -->

1.  In your Data Factory, click on the whitespace of the designer surface.

<!-- -->

41. Edit the parameters of the pipeline and add **EmailTo** of type **String** and the value of your email address.  
    <img src=&quot;Media\image0200.png&quot; style=&quot;width:4.46429in;height:1.21432in&quot; />

<!-- -->

13. Add Web Activity to send failure notification

<!-- -->

1.  Add a **Web** Activity to the pipeline.  
    <img src=&quot;Media\image0191.png&quot; style=&quot;width:4.76042in;height:2.97831in&quot; />

<!-- -->

42. Set the name of the Web Activity to **Send Failure Notification**.

43. On the Settings tab, enter the **URL** from the HTTP trigger of the relevant Logic App you created (previously copied in step **12.l**)

44. Set the **Method** to **POST**.

45. Click **+New** next to **Headers**.

46. In this Header section, enter **Content-Type** for name and **application/json** for value.

47. In the Body field add the contents of the file **\\M03-L02-Lab1\\WebActivityBodyFailure.txt**.

    {

    &quot;DataFactoryName&quot;:

    &quot;@{pipeline().DataFactory}&quot;,

    &quot;PipelineName&quot;:

    &quot;@{pipeline().Pipeline}&quot;,

    &quot;PipelineStatus&quot;:

    &quot;@{activity(&#39;Validate Import Rows&#39;).error.message}&quot;,

    &quot;EmailTo&quot;:

    &quot;@{pipeline().parameters.EmailTo}&quot;

    }

<!-- -->

14. Copy the Web Activity to send a success notification

    1.  Right click on your Send Failure Notification Web activity and select **Copy**

        <img src=&quot;Media\image0189.png&quot; style=&quot;width:3.57815in;height:1.34376in&quot; alt=&quot;Graphical user interface, application Description automatically generated&quot; />

    2.  Right click on the whitespace of the pipeline canvas and choose **Paste**

        <img src=&quot;Media\image0192.png&quot; style=&quot;width:2.93752in;height:0.92188in&quot; alt=&quot;Graphical user interface Description automatically generated with medium confidence&quot; />

    3.  Rename your new Web activity to Send Success Notification

<!-- -->

48. Go to the Settings tab and delete the code in the Body field. Replace the contents of the boody field with add the contents of the file **\\M03-L02-Lab1\\WebActivityBodySuccess.txt**.

    {

    &quot;DataFactoryName&quot;:

    &quot;@{pipeline().DataFactory}&quot;,

    &quot;PipelineName&quot;:

    &quot;@{pipeline().Pipeline}&quot;,

    &quot;PipelineStatus&quot;:

    &quot;Completed Successfully&quot;,

    &quot;EmailTo&quot;:

    &quot;@{pipeline().parameters.EmailTo}&quot;

    }

<!-- -->

15. Configure the Flow Control

<!-- -->

1.  The Pipeline should have 4 activities  
    <img src=&quot;Media\image0195.png&quot; style=&quot;width:4.60417in;height:1.5662in&quot; />

<!-- -->

49. Select the green box next to **Import CSV** and drag it to the **Validate Import Rows** activity. This will create a success path between the two activities.  
    <img src=&quot;Media\image0194.png&quot; style=&quot;width:4.65625in;height:1.56303in&quot; />

50. Select the green box next to **Validate Import Rows** and drag it to the **Send Success** activity.

51. Select the **Validate Import Rows** activity and notice the Add output icon in the lower right corner of the activity.

    <img src=&quot;Media\image0193.png&quot; style=&quot;width:1.45004in;height:0.91685in&quot; />

52. Click on the Add output icon and choose **Failure**.

    <img src=&quot;Media\image0174.png&quot; style=&quot;width:2.1331in;height:1.7574in&quot; />

53. The pipeline will look like this:  
    <img src=&quot;Media\image0155.png&quot; style=&quot;width:4.86735in;height:1.52885in&quot; />

54. If you have connected your Data Factory to a Git repository, click **Save**.

<!-- -->

16. Execute the pipeline

<!-- -->

1.  We are now ready to execute the pipeline. The stored procedure used in the validation phase is designed to error when there are no rows imported, as you might do in a real-world case. But it is also configured to error when there are more than 300 rows in the table, which in our case indicates that the table was not truncated before the import (we haven’t implemented that step).

<!-- -->

55. First, use the **Publish** button in the toolbar to ensure the changes are pushed to the ADF service.  
    <img src=&quot;Media\image0154.png&quot; style=&quot;width:4.65625in;height:0.33429in&quot; />

56. Make sure the publish process completes before proceeding.

57. Click either the Debug or Trigger method to execute the pipeline.  
    <img src=&quot;Media\image0153.png&quot; style=&quot;width:4.59375in;height:1.58229in&quot; />

58. If using the Debug method, you should see indications in the designer as it progresses through the execution. If you used the Trigger method, then switch to the Monitoring tab and view the execution process and outcome.

59. When complete you will be able to see (in the run tasks) which pathway was taken. If using Debug method, you can also see the pathway through the icons on the designer. You should also receive an email.  
    <img src=&quot;Media\image0156.png&quot; style=&quot;width:5.125in;height:3.37122in&quot; />

60. Execute the pipeline again. This time it should follow the Failure path due to the conditions in our validation stored procedure. You should also receive an email message reporting the failure.

61. <img src=&quot;Media\image0158.png&quot; style=&quot;width:5.13542in;height:3.00828in&quot; />

Exercise 2 has been completed.

### Exercise 3: Extend the Control Flow with Lookup and IF Condition activities

This exercise shows how to extend the existing pipeline with additional Flow Control using both activity output and specifically designed activities. In this scenario we need to add additional logic to check if the staging table contains data and then perform a truncation before continuing.

#### Tasks

1.  Rename the existing pipeline

<!-- -->

1.  We will use the existing pipeline as a child to avoid duplicating activities. Edit the existing pipeline you created in the previous exercise. On the Properties panel to the right, rename the pipeline to **pipeline\_ImportData**.  
    <img src=&quot;Media\image0157.png&quot; style=&quot;width:5.4892in;height:1.92708in&quot; />

<!-- -->

62. If you have Git enabled, select **Save** in the pipeline toolbar. Otherwise, click **Publish**.

<!-- -->

2.  Create a new pipeline

<!-- -->

1.  Create a new pipeline by clicking the + button under Factory Resources and selecting Pipeline.

2.  Rename the pipeline to **pipeline\_ImportData\_Control**.  
    <img src=&quot;Media\image0148.png&quot; style=&quot;width:3.21357in;height:4.18753in&quot; />

<!-- -->

63. If you have Git enabled, select **Save** in the pipeline toolbar.

<!-- -->

3.  Add a Lookup activity to the pipeline

<!-- -->

64. Locate the **Lookup** activity in the General section and drag it onto the designer surface.  
    <img src=&quot;Media\image0147.png&quot; style=&quot;width:3.72917in;height:3.02995in&quot; />

65. Change the name of the activity to **Lookup Staging Row Count**.  
    <img src=&quot;Media\image0146.png&quot; style=&quot;width:4.19792in;height:1.41366in&quot; />

66. Switch to the **Settings** tab. Select the **Source Dataset** as ProductsStaging (the Azure SQL Database dataset configured earlier).

67. Set the Use Query to **Stored Procedure** and select the **\[SalesLT\].\[usp\_GetRowCountProductStaging\]** stored procedure from the drop-down.

68. Take note there is a **First Row Only** check box at the bottom of settings. In this case leaving that checked is ok. Be sure to review the documentation regarding the changes to behavior with that setting and a dataset.

69. Select **Save** in the pipeline toolbar if you have Git enabled.

<!-- -->

4.  Add an IF Condition activity to the pipeline

<!-- -->

1.  Locate the **IF Connection** activity in the Iteration & Conditions section and drag it onto the designer surface.  
    <img src=&quot;Media\image0149.png&quot; style=&quot;width:3.55972in;height:3.07216in&quot; />

<!-- -->

70. Change the name of the activity to **Actions on Staging Row Count**.  
    <img src=&quot;Media\image0152.png&quot; style=&quot;width:4in;height:0.87607in&quot; />

71. Create an Activity Output Condition between the **Lookup Staging Row Count** and the **Actions on Staging Row Count** for **Success**.  
    <img src=&quot;Media\image0151.png&quot; style=&quot;width:3.13542in;height:0.94665in&quot; />

72. Switch to the **Activities** tab of the **Actions on Staging Row Count** activity. Place the cursor in the Expression field, then select the **Add dynamic content** link or press **Alt+P**.

73. Enter the following into the Expression field. This will use the value from the lookup activity as part of an evaluation which returns true/false.

    **@equals(activity(&#39;Lookup Staging Row Count&#39;).output.firstRow.RowCount, 0)  
    **  
    <img src=&quot;Media\image0150.png&quot; style=&quot;width:3.48958in;height:0.94174in&quot; />

For more on Logical Functions see <https://docs.microsoft.com/en-us/azure/data-factory/control-flow-expression-language-functions>

74. Click **Finish** to add the Dynamic content to the Expression field.

75. Click on the Pencil for to the Case = True.

    <img src=&quot;Media\image0169.png&quot; style=&quot;width:3.46878in;height:0.67709in&quot; />

76. This will open a new child designer surface. Notice the context path within the pipeline above the designer surface.  
    <img src=&quot;Media\image0167.png&quot; style=&quot;width:3.59929in;height:2.328in&quot; />

77. Here we will use the existing pipeline to avoid duplicating activities.  
    Locate the **Execute Pipeline** activity in the **General** section. Drag it onto the designer surface.  
    <img src=&quot;Media\image0170.png&quot; style=&quot;width:4.17619in;height:2.408in&quot; />

78. Rename the activity to **Import Data on True**.

79. Switch to the **Settings** tab, select **pipeline\_ImportData** from the Invoked pipeline drop down.  
    <img src=&quot;Media\image0173.png&quot; style=&quot;width:3.26042in;height:2.83057in&quot; />

80. Notice that the **Parameters** from the Import Data pipeline are carried over. The value could be defined by a parameter on the control pipeline, or even a looked-up value from a database table or config file. In a real-world solution you would most likely configure those settings. To keep it simple for this exercise just use the default value you have already configured (for example: hard coded configuration).  
    <img src=&quot;Media\image0172.png&quot; style=&quot;width:5.27551in;height:1.95239in&quot; />

81. Click **Save** if you have Git configured.

82. Navigate back to the main designer surface of the pipeline using the contextual path at the top of the designer surface. In other words, click on the **pipeline\_ImportData\_Control** hyperlink.

    <img src=&quot;Media\image0171.png&quot; style=&quot;width:4.27273in;height:0.97917in&quot; />

83. Click on the Pencil for to the Case = False. Again, this opens a child designer surface.

84. Here we will again call the **pipeline\_ImportData** pipeline. Add an Execute Pipeline activity to this designer surface as you previously did. Since activity names must be unique within a pipeline, use the name **Import Data on False**.

85. Based on the business requirements we need to truncate the table before importing if it already has data.  
    Locate the Stored Procedure activity in the **General** section and drag it onto the designer surface.  
    <img src=&quot;Media\image0162.png&quot; style=&quot;width:4.70833in;height:3.36927in&quot; />

86. Change the name of the activity to **Truncate Staging Table**.

87. Switch to the **Settings** tab and select your Azure SQL Linked Service. Then select **\[SalesLT\].\[usp\_TruncateProductStaging\]** from the drop-down list.

88. Add an **Activity Output Condition** between this Stored Procedure Activity and the Execute Pipeline activity **on Success**.  
    <img src=&quot;Media\image0161.png&quot; style=&quot;width:3.39474in;height:1.08015in&quot; />

89. Navigate back to the main designer surface of the pipeline using the contextual path at the top of the designer surface.

90. Select **Save** on the Pipeline to save changes, if using Git.

91. Click **Publish** to deploy your changes to the Data Factory service.

<!-- -->

5.  Execute the Pipeline

<!-- -->

1.  Using the same methods as in the earlier exercise execute the pipeline **pipeline\_ImportData\_Control** and observe the paths used. In the following screenshot the execution has followed the False conditional path.  
      
    <img src=&quot;Media\image0160.png&quot; style=&quot;width:5.384in;height:3.73831in&quot; />

<!-- -->

92. You could try truncating the table manually and then executing again to force the activity to follow the true path.

Exercise 3 has been completed.
">
    <input type="hidden" id="activities" value="[]">
    <input type="hidden" id="replacementTokens" value="[{&quot;Token&quot;:&quot;@lab.LabProfile.Id&quot;,&quot;Replacement&quot;:&quot;38671&quot;},{&quot;Token&quot;:&quot;@lab.CtrlAltDelete&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;ctrlAltDeleteLink&#39;&gt;Ctrl+Alt+Delete&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(WIN10).SelectLink&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;selectMachineLink&#39; data-data=&#39;63124&#39;&gt;WIN10&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(WIN10).Username&quot;,&quot;Replacement&quot;:&quot;Power&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(WIN10).Password&quot;,&quot;Replacement&quot;:&quot;Pa$$$$w0rd&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(MS).SelectLink&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;selectMachineLink&#39; data-data=&#39;54597&#39;&gt;MS&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(MS).Username&quot;,&quot;Replacement&quot;:&quot;Power&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(MS).Password&quot;,&quot;Replacement&quot;:&quot;Pa$$$$w0rd&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(DC).SelectLink&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;selectMachineLink&#39; data-data=&#39;54598&#39;&gt;DC&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(DC).Username&quot;,&quot;Replacement&quot;:&quot;Administrator&quot;},{&quot;Token&quot;:&quot;@lab.VirtualMachine(DC).Password&quot;,&quot;Replacement&quot;:&quot;Pa$$$$w0rd&quot;},{&quot;Token&quot;:&quot;@lab.OpticalMedia(5638).LoadLink&quot;,&quot;Replacement&quot;:&quot;&lt;a href=&#39;#&#39; class=&#39;loadMediaLink opticalMedia&#39; data-data=&#39;5638&#39;&gt;Introduction to Commands - 0050&lt;/a&gt;&quot;},{&quot;Token&quot;:&quot;@lab.LabInstance.Id&quot;,&quot;Replacement&quot;:&quot;[ID]&quot;},{&quot;Token&quot;:&quot;@lab.LabInstance.GlobalId&quot;,&quot;Replacement&quot;:&quot;[lodID]&quot;},{&quot;Token&quot;:&quot;@lab.LabInstance.StartDate&quot;,&quot;Replacement&quot;:&quot;20190108&quot;},{&quot;Token&quot;:&quot;@lab.User.Id&quot;,&quot;Replacement&quot;:&quot;[USERID]&quot;},{&quot;Token&quot;:&quot;@lab.User.FirstName&quot;,&quot;Replacement&quot;:&quot;[FIRSTNAME]&quot;},{&quot;Token&quot;:&quot;@lab.User.LastName&quot;,&quot;Replacement&quot;:&quot;[LASTNAME]&quot;},{&quot;Token&quot;:&quot;@lab.User.Email&quot;,&quot;Replacement&quot;:&quot;[EMAIL]&quot;},{&quot;Token&quot;:&quot;@lab.User.ExternalId&quot;,&quot;Replacement&quot;:&quot;[EXTERNALID]&quot;},{&quot;Token&quot;:&quot;@lab.Tag&quot;,&quot;Replacement&quot;:&quot;[TAG]&quot;}]">

    <textarea id="copyInput" value="" style="position: absolute; left:-10000px; top:-10000px; "></textarea>

    <script type="text/javascript"> 
    
        String.prototype.replaceAll = function(search, replacement) {
            var target = this;
            return target.replace(new RegExp(search, 'g'), replacement);
        };

        var childWindows = [];

        function showClickFeedbackMessage(text, x, y, duration) {
            var $message = $("<div class='clickFeedbackMessage noselect'>" + text + "</div>");
            $message.appendTo($("body")).hide();
            $message.css({ left: x, top: y });
            $message.fadeIn("fast");
            window.setTimeout(function () {
                $message.fadeOut("fast", function () { $message.remove(); });
            }, duration);
        }

        function copyableClicked(element) {
            //only copy if we are clicking, not if we have used the mouse to select the text manually.
            var selectedText;
            if (window.getSelection) {
                selectedText = window.getSelection().toString();
            } else if (document.selection && document.selection.type !== "Control") {
                selectedText = document.selection.createRange().text;
            }
            if (selectedText) { return };

            var $element = $(element);
            var text = $element.text();
            $("#copyInput").val(text).select();
            var offset = $element.offset();
            var x = offset.left;
            var y = offset.top - 40;
            try {
                var successful = document.execCommand("copy");
                if (successful) {
                    showClickFeedbackMessage("Copied to clipboard", x, y, 2000);
                } else {
                    showClickFeedbackMessage("Copying was unsuccessful", x, y, 2000);
                }
            } catch (err) {
                showClickFeedbackMessage("Copying was unsuccessful", x, y, 2000);
                console.log("Unable to copy. " + err);
            }
        }

        function setupKnowledgeExpanders() {
            $(".knowledge").each(function () {
                var knowledge = this;
                var $knowledge = $(this);
                var $moreKnowledge = $knowledge.next();
                if ($moreKnowledge.is(".moreKnowledge")) {
                    var maxHeight = 100;
                    var leeway = 100;
                    var diff = knowledge.scrollHeight - maxHeight;
                    if (diff < leeway) {
                        $knowledge.removeClass("collapsed");
                        $moreKnowledge.find("a").hide();
                    } else {
                        //this is tall content, let's show the 'more' link
                        $moreKnowledge.find("a").show();
                        $knowledge.addClass("collapsed");
                    }
                }
            });
        }

        var variables = {};

        function processVariables() {
            $("span.variable").each(function () {
                var $this = $(this);
                var name = $this.attr("data-name");
                if (name in variables) {
                    $this.html(variables[name]);
                } else {
                    $this.text("<" + name + ">");
                }
            });
            $("input.variableTextBox").each(function () {
                var $this = $(this);
                var name = $this.attr("data-name");
                if (name in variables) {
                    $this.val(variables[name]);
                } else {
                    $this.val("");
                }
            });
            $("code").each(function () {
                var originalHtml = this.originalHtml ? this.originalHtml : this.innerHTML;
                var newHtml = originalHtml;
                for (var name in variables) {
                    var val = variables[name];
                    var regex = new RegExp('<span class="nocode">&lt;' + name + '&gt;</span>', 'g');
                    newHtml = newHtml.replace(regex, val);
                }
                if (originalHtml != newHtml || originalHtml != this.innerHTML) {
                    this.originalHtml = originalHtml;
                    this.innerHTML = newHtml;
                }
            });
        }
        
        window.onload = function () {

            var rawContent = document.getElementById("rawContent").value;
            var contentRoot = "./"
            var activitiesString = document.getElementById("activities").value;
            var activities = (activitiesString == null || activitiesString.length == 0) ? [] : JSON.parse(activitiesString);
            var replacementTokensString = document.getElementById("replacementTokens").value;
            var replacementTokens = (replacementTokensString == null || replacementTokensString.length == 0) ? [] : JSON.parse(replacementTokensString);
            instructionsProcessor.process(rawContent, "instructions", false, contentRoot, replacementTokens,
                function ($page) {
                    setupKnowledgeExpanders();
                },
                activities
            );
            $(".page").each(function () {
                var $page = $(this);
                if ($page.find("iframe.externalManual").length > 0) {
                    $page.css("padding", 0);
                }
            });

            $("body").on("click", ".moreKnowledgeLink", function (e) {
                e.preventDefault();
                var $link = $(this);
                var $knowledge = $link.parent().prev();
                if ($knowledge.hasClass("expanded")) {
                    $knowledge.removeClass("expanded");
                    $link.text("more...");
                } else {
                    $knowledge.addClass("expanded");
                    $link.text("...less");
                }
            }).on("click", ".copyable, code:not(.nocopy)", function (e) {
                copyableClicked(this);
            }).on("click", ".dialogLink", function (e) {
                e.preventDefault();
                e.stopImmediatePropagation();
                var $dialogLink = $(this);
                var title = $dialogLink.attr("title");
                var target = $dialogLink.attr("data-target");
                if (target) {
                    var $hiddenDialog = $("blockquote.referenceContent[data-id='" + target + "']");
                    if ($hiddenDialog.length === 0) {
                        alert('CONTENT ERROR: Unable to find a reference content "' + target + '"');
                    } else {
                        showDialog({title:title, content: $hiddenDialog.html() });
                    }
                }
                else {
                    showDialog({title:title, url: $dialogLink.attr("href"), isInstructions: $dialogLink.hasClass("instructions") });
                }
            }).on("click", ".videoLink, video", function (e) {
                e.preventDefault();
                var videoUrl = $(this).hasClass("videoLink") ? this.href : this.src;
                var url = "./Media/" + videoUrl.split('/').pop().replace(/\#(.*?)$/, '').replace(/\?(.*?)$/, '')
                if (this.title) {
                    
                }
                var videoWindow = window.open(url, "videoWindow", "menubar=no,location=no,resizable=yes,scrollbars=yes,status=no");
                childWindows.push(videoWindow);
                try {
                    videoWindow.focus();
                } catch (e) {

                }
            }).on("click", ".imageLink, img", function (e) {
                var $this = $(this);
                if ($this.parent().is("a")) return;
                e.preventDefault();
                e.stopImmediatePropagation();
                var imgUrl = $this.hasClass("imageLink") ? this.href : this.src;
                var url = "./Media/" + imgUrl.split('/').pop().replace(/\#(.*?)$/, '').replace(/\?(.*?)$/, '')
                if (this.title) {
                    
                }
                var imageWindow = window.open(url, "imageWindow", "menubar=no,location=no,resizable=yes,scrollbars=yes,status=no");
                childWindows.push(imageWindow);
                try {
                    imageWindow.focus();
                } catch (e) {

                }
            }).on("click", ".tipLink", function (e) {
                e.preventDefault();
                var $tiplink = $(this);
                var $hiddenTip = $tiplink.next();
                var offset = $(this).offset();
                var x = offset.left;
                var y = offset.top + 25;
                showClickFeedbackMessage($hiddenTip.html().replaceAll('<code title="Copy to clipboard" class="prettyprint">','<code title="Copy to clipboard" style="background-color:#8888;" class="prettyprint">').replaceAll("class",'style="background-color:#8888;" class'), x, y, 5000);
            }).on("change", ".variableTextBox", function () {
                var $textBox = $(this);
                var name = $textBox.attr("data-name");
                var val = $textBox.val();
                if (val == null || val.length == 0) {
                    if (name in variables) {
                        delete variables[name];
                    }
                } else {
                    variables[name] = val;
                }
                processVariables();
            });;

            $(window).resize(function () {
                setupKnowledgeExpanders();
            }).unload(function () {
                closeAllChildWindows();
            });

            function closeAllChildWindows() {
                for (var i = 0; i < childWindows.length; i++) {
                    try {
                        childWindows[i].close();
                    } catch (e) {
                    }
                }
                childWindows = [];
            }

            function showDialog(options) {
                if (!options) return;
                var $dialog = $("#modalDialog");
                var isUpdatedContent = false;
                if ($dialog.length > 0) {
                    $dialog.find(".dialogContent").html("");
                    $dialog.find(".dialogButtons").html("");
                    isUpdatedContent = true;
                } else {
                    var $dialog = $('<div id="modalDialog" class="dialog"><div class="dialogMask"></div><div class="dialogBox"><div class="dialogCloseButton"></div><div class="dialogTitle"></div><div class="dialogContent"></div><div class="dialogButtons"></div></div></div>');
                }
                var $dialogBox = $dialog.find(".dialogBox");
                var close = function () {
                    var h = $dialogBox.outerHeight();
                    var offset = $dialogBox.offset();
                    $dialogBox.css("marginTop", 0).animate({ marginTop: -h - offset.top }, 300);
                    $dialog.delay(200).fadeOut("fast", function () { $dialog.remove(); });
                }
                $dialog.find(".dialogCloseButton").click(close);

                if (options.title) {
                    $dialog.find(".dialogTitle").html(options.title).show();
                } else {
                    $dialog.find(".dialogTitle").hide();
                    $dialog.addClass("noTitle");
                }
                if (options.content) {
                    $dialog.find(".dialogContent").removeClass("noScroll").append(options.content);
                } else if (options.url) {
                    var urlLower = options.url.toLowerCase();
                    if (urlLower.indexOf(".mp4") !== -1) {
                        $dialog.find(".dialogContent").removeClass("noScroll").append('<video src="' + options.url + '" controls autoplay></video>');
                        var $video = $("#contentDialogVideo");
                        try {
                            $video[0].play();
                        } catch (e) {
                            //
                        }
                    } else if (urlLower.indexOf(".png") !== -1 || urlLower.indexOf(".jpg") !== -1 || urlLower.indexOf(".jpeg") !== -1 || urlLower.indexOf(".gif") !== -1) {
                        $dialog.find(".dialogContent").removeClass("noScroll").append('<img src="' + options.url + '" controls></iframe>');
                    } else if (options.isInstructions || urlLower.indexOf(".md") !== -1) {
                        $dialog.find(".dialogContent").removeClass("noScroll").append('<div id="instructionsDialog"></div>');
                        window.setTimeout(function () {
                            instructionsProcessor.processUrl(options.url, "instructionsDialog");
                            if (options.url.indexOf("#") >= 0) {
                                window.setTimeout(function () {
                                    var hash = options.url.substr(options.url.indexOf("#"));
                                    var $element = $("#instructionsDialog " + hash);
                                    if ($element.length > 0) {
                                        $dialog.find(".dialogContent").scrollTop($element.position().top);
                                    }
                                }, 400); //leave time for the content to layout... the dialog takes 400ms to animate anyway, which should be sufficient.
                            }
                        }, 1);
                    } else {
                        $dialog.find(".dialogContent").addClass("noScroll").append('<iframe id="contentDialogIFrame" src="' + options.url + '" style="width:100%;height:100%;border:none;" allowfullscreen></iframe>');
                    }
                } else {
                    $dialog.find(".dialogContent").hide();
                }
                if (options.buttons && options.buttons.length > 0) {
                    $dialog.addClass("hasButtons");
                    var $dialogButtons = $dialog.find(".dialogButtons");
                    var numButtons = options.buttons.length;
                    for (var i = 0; i < numButtons; i++) {
                        var button = options.buttons[i];
                        var $button = $("<input type='button' value='" + button.text + "' />");
                        if (button.click) {
                            $button.click(button.click);
                        }
                        if (button.primary) {
                            $button.addClass("primary");
                        }
                        if (button.closeDialog) {
                            $button.click(close);
                        }
                        $dialogButtons.append($button);
                    }
                }
                if (!isUpdatedContent) {
                    $("body").append($dialog);
                    $dialog.hide().fadeIn("fast", function () {
                        if (options.open) {
                            options.open();
                        }
                    });
                    var h = $dialogBox.outerHeight();
                    var offset = $dialogBox.offset();
                    $dialogBox.css("marginTop", -h - offset.top).animate({ marginTop: 0 }, 400);
                }
                return {
                    close: close
                };
            }

        }

        function getScrollTop() {
            return document.body.scrollTop;
        }

    </script>


</body>
</html>
